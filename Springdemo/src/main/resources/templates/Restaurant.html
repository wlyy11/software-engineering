<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>餐厅人流量检测系统 餐厅管理</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #4a6fcb, #1a2a6c);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 30px 0;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-top: 20px;
        }

        @media (max-width: 992px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            padding: 30px;
            margin-bottom: 30px;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-title {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            color: #1a2a6c;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }

        .card-title i {
            margin-right: 12px;
            font-size: 1.8rem;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
            background-color: white;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: #4a6fcb;
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 111, 203, 0.2);
        }

        .btn {
            padding: 14px 28px;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-add {
            background: linear-gradient(to right, #00b09b, #96c93d);
        }

        .btn-add:hover {
            background: linear-gradient(to right, #96c93d, #00b09b);
        }

        .btn-delete {
            background: linear-gradient(to right, #e74c3c, #c0392b);
        }

        .btn-delete:hover {
            background: linear-gradient(to right, #c0392b, #e74c3c);
        }

        .btn-complete {
            background: linear-gradient(to right, #4a6fcb, #1a2a6c);
        }

        .btn-complete:hover {
            background: linear-gradient(to right, #1a2a6c, #4a6fcb);
        }

        .btn-traffic {
            background: linear-gradient(to right, #8E2DE2, #4A00E0);
        }

        .btn-traffic:hover {
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
        }

        .restaurant-list {
            margin-top: 20px;
        }

        .restaurant-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #eaeaea;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .restaurant-item:hover {
            border-color: #4a6fcb;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .restaurant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .restaurant-header h3 {
            color: #1a2a6c;
            font-size: 1.4rem;
        }

        .restaurant-info {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
        }

        .info-item .label {
            color: #777;
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .info-item .value {
            font-weight: 600;
            color: #333;
        }

        .restaurant-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px 0;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(26, 42, 108, 0.2);
            border-top: 5px solid #1a2a6c;
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-restaurants {
            text-align: center;
            padding: 40px 20px;
            color: #777;
        }

        .no-restaurants i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #b0b0b0;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .footer {
            text-align: center;
            padding: 30px 0;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 40px;
            font-size: 0.9rem;
        }

        .manager-ribbon {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(to right, #ff9800, #ff5722);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            z-index: 10;
        }

        /* 新增的预约排队样式 */
        .appointment-list {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .appointment-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #eee;
            transition: all 0.3s;
        }

        .appointment-item:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .appointment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .appointment-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-waiting {
            background: #ffecb3;
            color: #ff9e00;
        }

        .status-confirmed {
            background: #c8e6c9;
            color: #388e3c;
        }

        .status-completed {
            background: #e0e0e0;
            color: #616161;
        }

        .appointment-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .detail-item {
            font-size: 0.9rem;
        }

        .detail-item .label {
            color: #777;
            margin-bottom: 3px;
        }

        .detail-item .value {
            font-weight: 500;
        }

        .appointment-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }

        .tab-container {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #1a2a6c;
            border-bottom-color: #1a2a6c;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 人流量图表容器 */
        .chart-container {
            height: 400px;
            margin-top: 20px;
            position: relative;
        }

        /* 人流量查看页面 */
        .traffic-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .back-btn {
            background: linear-gradient(to right, #4a6fcb, #1a2a6c);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .traffic-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .date-input {
            flex: 1;
            min-width: 200px;
        }

        .date-input input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
        }

        .traffic-data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .traffic-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .traffic-card h3 {
            color: #1a2a6c;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #1a2a6c;
            text-align: center;
            margin: 15px 0;
        }

        .stat-label {
            text-align: center;
            color: #666;
            font-weight: 500;
        }

        .peak-time {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        /* 模态框样式 */
        #trafficModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .chart-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        #modalOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1><i class="fas fa-utensils"></i> 餐厅管理系统</h1>
        <p>经理专属界面 - 管理您的餐厅</p>
    </header>

    <div class="manager-ribbon">
        <i class="fas fa-crown"></i> 经理
    </div>

    <div class="dashboard">
        <!-- 左侧：添加新餐厅 -->
        <div class="card">
            <div class="card-title">
                <i class="fas fa-plus-circle"></i>
                <h2>添加新餐厅</h2>
            </div>

            <div id="formMessage"></div>

            <form id="addRestaurantForm">
                <div class="form-group">
                    <label for="restaurantName"><i class="fas fa-signature"></i> 餐厅名称</label>
                    <input type="text" id="restaurantName" placeholder="请输入餐厅名称" required>
                </div>

                <div class="form-group">
                    <label for="restaurantAddress"><i class="fas fa-map-marker-alt"></i> 餐厅地址</label>
                    <input type="text" id="restaurantAddress" placeholder="请输入详细地址" required>
                </div>

                <div class="form-group">
                    <label for="maxCapacity"><i class="fas fa-users"></i> 最大容量</label>
                    <input type="number" id="maxCapacity" placeholder="请输入最大容纳人数" min="10" required>
                </div>

                <button type="submit" class="btn btn-add">
                    <i class="fas fa-plus"></i> 添加餐厅
                </button>
            </form>
        </div>

        <!-- 右侧：我的餐厅管理 -->
        <div class="card">
            <div class="card-title">
                <i class="fas fa-store"></i>
                <h2>我管理的餐厅</h2>
            </div>

            <div class="tab-container">
                <div class="tab active" data-tab="restaurants">餐厅信息</div>
                <div class="tab" data-tab="appointments">预约处理</div>
            </div>

            <div id="restaurantsContainer" class="tab-content active">
                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                    <p>正在加载餐厅信息...</p>
                </div>
            </div>

            <div id="appointmentsContainer" class="tab-content">
                <div class="loading" id="loadingAppointments">
                    <div class="spinner"></div>
                    <p>正在加载预约信息...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>©餐厅管理系统 | 当前用户: <span id="currentUsername">经理</span></p>
    </div>

    <!-- 人流量查看弹窗 -->
    <div id="trafficModal" class="card">
        <div class="traffic-header">
            <h2 id="trafficRestaurantName"><i class="fas fa-chart-line"></i> 餐厅人流量分析</h2>
            <button onclick="closeTrafficModal()" class="btn btn-delete">
                <i class="fas fa-times"></i> 关闭
            </button>
        </div>

        <div class="traffic-controls">
            <div class="date-input">
                <label for="dateRange"><i class="fas fa-calendar-alt"></i> 选择日期 (格式: 月_日，如6_09)</label>
                <input type="text" id="dateRange" placeholder="输入日期 (如: 6_09)">
            </div>

            <button class="btn btn-traffic" onclick="loadDateTrafficData()">
                <i class="fas fa-sync-alt"></i> 查询日期数据
            </button>
        </div>

        <div class="chart-container">
            <canvas id="trafficChart"></canvas>
        </div>

    </div>

    <!-- 模态背景遮罩 -->
    <div id="modalOverlay"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const currentUser = localStorage.getItem('username');
        document.getElementById('currentUsername').textContent = currentUser;

        const addRestaurantForm = document.getElementById('addRestaurantForm');
        const restaurantsContainer = document.getElementById('restaurantsContainer');
        const appointmentsContainer = document.getElementById('appointmentsContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loadingAppointments = document.getElementById('loadingAppointments');
        const formMessage = document.getElementById('formMessage');

        // 标签切换功能
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // 更新标签状态
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // 更新内容显示
                const tabName = this.dataset.tab;
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}Container`).classList.add('active');

                // 如果是预约标签，加载预约数据
                if (tabName === 'appointments') {
                    loadManagerAppointments();
                }
            });
        });

        // 加载经理管理的餐厅
        function loadManagerRestaurants() {
            loadingIndicator.style.display = 'block';

            fetch(`/user/viewOwnerRestaurant?currentUsername=${currentUser}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.code === 200 && data.data) {
                        displayRestaurants(data.data);
                    } else {
                        displayNoRestaurants();
                    }
                })
                .catch(error => {
                    console.error('加载餐厅失败:', error);
                    restaurantsContainer.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-circle"></i> 加载餐厅失败，请稍后再试</div>';
                })
                .finally(() => {
                    loadingIndicator.style.display = 'none';
                });
        }

        // 显示餐厅列表
        function displayRestaurants(restaurants) {
            if (restaurants.length === 0) {
                displayNoRestaurants();
                return;
            }

            let html = '<div class="restaurant-list">';
            restaurants.forEach(restaurant => {
                html += `
                    <div class="restaurant-item">
                        <div class="restaurant-header">
                            <h3>${restaurant.name}</h3>
                            <span class="appointment-status status-confirmed">${restaurant.status || '营业中'}</span>
                        </div>
                        <div class="restaurant-info">
                            <div class="info-item">
                                <div class="label"><i class="fas fa-map-marker-alt"></i> 地址</div>
                                <div class="value">${restaurant.local || '地址未提供'}</div>
                            </div>

                            <div class="info-item">
                                <div class="label"><i class="fas fa-users"></i> 最大容量</div>
                                <div class="value">${restaurant.maxCapacity || '未指定'} 人</div>
                            </div>

                        </div>

                        <div class="restaurant-actions">
                            <button class="btn btn-traffic" onclick="viewTraffic('${restaurant.name}')">
                                <i class="fas fa-chart-line"></i> 查看人流量
                            </button>
                            <button class="btn btn-delete" onclick="deleteRestaurant('${restaurant.name}')">
                                <i class="fas fa-trash"></i> 删除餐厅
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            restaurantsContainer.innerHTML = html;
        }

        // 显示无餐厅信息
        function displayNoRestaurants() {
            restaurantsContainer.innerHTML = `
                <div class="no-restaurants">
                    <i class="fas fa-store-slash"></i>
                    <h3>暂无管理的餐厅</h3>
                    <p>您还没有添加任何餐厅，请使用左侧表单添加新餐厅</p>
                </div>
            `;
        }

        // 加载经理的预约信息
        function loadManagerAppointments() {
            loadingAppointments.style.display = 'block';

            fetch(`/user/manager_Appoint?currentUsername=${currentUser}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.code === 200 && data.data) {
                        displayAppointments(data.data);
                    } else {
                        displayNoAppointments();
                    }
                })
                .catch(error => {
                    console.error('加载预约失败:', error);
                    appointmentsContainer.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-circle"></i> 加载预约失败，请稍后再试</div>';
                })
                .finally(() => {
                    loadingAppointments.style.display = 'none';
                });
        }

        // 显示预约列表
        function displayAppointments(appointments) {
            if (appointments.length === 0) {
                displayNoAppointments();
                return;
            }

            // 按状态分组
            const waitingAppointments = appointments.filter(a => a.status === 'WAITING');
            const confirmedAppointments = appointments.filter(a => a.status === 'CONFIRMED');
            const completedAppointments = appointments.filter(a => a.status === 'COMPLETED');

            let html = '<div class="appointment-list">';

            // 等待中的预约
            if (waitingAppointments.length > 0) {
                html += '<h3 style="margin: 15px 0 10px; color: #1a2a6c;">等待处理</h3>';
                waitingAppointments.forEach(app => {
                    html += createAppointmentItem(app, true);
                });
            }

            // 已确认的预约
            if (confirmedAppointments.length > 0) {
                html += '<h3 style="margin: 15px 0 10px; color: #1a2a6c;">已确认</h3>';
                confirmedAppointments.forEach(app => {
                    html += createAppointmentItem(app, false);
                });
            }

            // 已完成的预约
            if (completedAppointments.length > 0) {
                html += '<h3 style="margin: 15px 0 10px; color: #1a2a6c;">已完成</h3>';
                completedAppointments.forEach(app => {
                    html += createAppointmentItem(app, false);
                });
            }

            html += '</div>';
            appointmentsContainer.innerHTML = html;
        }

        // 创建预约项HTML
        function createAppointmentItem(app, showCompleteButton) {
            const date = new Date(app.createdAt);
            const dateStr = date.toLocaleString('zh-CN');

            let statusClass = 'status-waiting';
            let statusText = '等待中';

            if (app.status === 'CONFIRMED') {
                statusClass = 'status-confirmed';
                statusText = '已确认';
            } else if (app.status === 'COMPLETED') {
                statusClass = 'status-completed';
                statusText = '已完成';
            }

            return `
                <div class="appointment-item">
                    <div class="appointment-header">
                        <h4>${app.user.name || '匿名用户'}</h4>
                        <span class="appointment-status ${statusClass}">${statusText}</span>
                    </div>

                    <div class="appointment-details">
                        <div class="detail-item">
                            <div class="label">餐厅</div>
                            <div class="value">${app.restaurant.name || '未知餐厅'}</div>
                        </div>

                        <div class="detail-item">
                            <div class="label">人数</div>
                            <div class="value">${app.partySize || 1}</div>
                        </div>

                        <div class="detail-item">
                            <div class="label">预约时间</div>
                            <div class="value">${dateStr}</div>
                        </div>
                    </div>

                    ${showCompleteButton ? `
                    <div class="appointment-actions">
                        <button class="btn btn-complete" onclick="completeAppointment(${app.id}, this)">
                            <i class="fas fa-check"></i> 完成处理
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // 显示无预约信息
        function displayNoAppointments() {
            appointmentsContainer.innerHTML = `
                <div class="no-restaurants">
                    <i class="far fa-calendar-times"></i>
                    <h3>暂无预约记录</h3>
                    <p>当前没有需要处理的预约</p>
                </div>
            `;
        }

        // 添加新餐厅
        addRestaurantForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const restaurantName = document.getElementById('restaurantName').value;
            const restaurantAddress = document.getElementById('restaurantAddress').value;
            const maxCapacity = document.getElementById('maxCapacity').value;

            // 保存原始按钮状态
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalHtml = submitBtn.innerHTML;

            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 添加中...';
            submitBtn.disabled = true;

            // 构建餐厅数据对象
            const restaurantData = {
                restaurant_name: restaurantName,
                local: restaurantAddress,
                maxCapacity: parseInt(maxCapacity)
            };

            // 发送请求
            fetch(`/user/New_Restaurant?currentUsername=${currentUser}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(restaurantData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.code === 200) {
                        formMessage.innerHTML = `
                        <div class="success-message">
                            <i class="fas fa-check-circle"></i>
                            餐厅添加成功！
                        </div>
                    `;

                        // 重置表单
                        addRestaurantForm.reset();

                        // 重新加载餐厅列表
                        loadManagerRestaurants();
                    } else {
                        formMessage.innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-circle"></i>
                            添加失败: ${data.message || '未知错误'}
                        </div>
                    `;
                    }
                })
                .catch(error => {
                    console.error('添加餐厅失败:', error);
                    formMessage.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        添加失败: ${error.message || '网络错误，请重试'}
                    </div>
                `;
                })
                .finally(() => {
                    submitBtn.innerHTML = originalHtml;
                    submitBtn.disabled = false;
                });
        });

        // 删除餐厅
        window.deleteRestaurant = function(restaurantName) {
            if (!confirm(`确定要删除餐厅 "${restaurantName}" 吗？此操作不可撤销！`)) {
                return;
            }

            fetch(`/user/deleteOwnerRestaurant?currentUsername=${currentUser}&restaurantname=${encodeURIComponent(restaurantName)}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert(`餐厅 "${restaurantName}" 已成功删除`);
                        loadManagerRestaurants();
                    } else {
                        alert(`删除失败: ${data.message || '未知错误'}`);
                    }
                })
                .catch(error => {
                    console.error('删除餐厅失败:', error);
                    alert('删除失败，请稍后再试');
                });
        };

        // 完成预约处理
        window.completeAppointment = function(appId, button) {
            if (!confirm('确定要标记此预约为已完成吗？')) {
                return;
            }

            const originalHtml = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';
            button.disabled = true;

            fetch(`/user/appoint_handle?currentUsername=${currentUser}&app_id=${appId}`, {
                method: 'POST'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.code === 200) {
                        // 重新加载预约列表
                        loadManagerAppointments();
                    } else {
                        throw new Error(data.message || '操作失败');
                    }
                })
                .catch(error => {
                    console.error('完成预约失败:', error);
                    alert(`操作失败: ${error.message}`);
                })
                .finally(() => {
                    button.innerHTML = originalHtml;
                    button.disabled = false;
                });
        };

        // 查看人流量
        window.viewTraffic = function(restaurantName) {
            document.getElementById('trafficRestaurantName').innerHTML =
                `<i class="fas fa-chart-line"></i> ${restaurantName} - 人流量分析`;

            document.getElementById('trafficModal').style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';

            // 加载最近10条记录
            loadRecentTrafficData(restaurantName);
        };

        // 加载特定日期人流量数据
        window.loadDateTrafficData = function() {

            const restaurantName = document.getElementById('trafficRestaurantName').textContent
                .replace(' - 人流量分析', '').trim();
            const date = document.getElementById('dateRange').value.trim();

            if (!date) {
                alert('请输入日期 (格式: 月_日，如6_09)');
                return;
            }

            const currentUser = localStorage.getItem('username');
            const chartContainer = document.getElementById('trafficChart').parentElement;

            if (!chartContainer) {
                console.warn('trafficChart元素不存在，无法渲染图表');
                return;
            }

            // 显示加载状态 - 但不移除canvas元素
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chart-loading';
            loadingDiv.innerHTML = '<div class="spinner"></div><p>正在加载数据...</p>';
            chartContainer.appendChild(loadingDiv);

            fetch(`/user/record_viewDate?date=${date}&res_name=${encodeURIComponent(restaurantName)}&currentUsername=${currentUser}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.code === 200 && data.data) {
                        // 移除加载状态
                        chartContainer.removeChild(loadingDiv);
                        renderTrafficChart(data.data);
                    } else {
                        throw new Error(data.message || '没有获取到数据');
                    }
                })
                .catch(error => {
                    console.error('加载人流量数据失败:', error);
                    chartContainer.innerHTML =
                        `<div class="error-message"><i class="fas fa-exclamation-circle"></i> 加载失败: ${error.message}</div>`;
                });
        };

        // 加载最近人流量数据
        function loadRecentTrafficData(restaurantName) {
            const currentUser = localStorage.getItem('username');
            const chartContainer = document.getElementById('trafficChart').parentElement;

            if (!chartContainer) {
                console.warn('trafficChart元素不存在，无法渲染图表');
                return;
            }

            // 显示加载状态 - 但不移除canvas元素
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chart-loading';
            loadingDiv.innerHTML = '<div class="spinner"></div><p>正在加载数据...</p>';
            chartContainer.appendChild(loadingDiv);

            fetch(`/user/record_viewManager?count=8&res_name=${encodeURIComponent(restaurantName)}&currentUsername=${currentUser}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.code === 200 && data.data) {
                        // 移除加载状态
                        chartContainer.removeChild(loadingDiv);
                        renderTrafficChart(data.data);
                    } else {
                        throw new Error(data.message || '没有获取到数据');
                    }
                })
                .catch(error => {
                    console.error('加载人流量数据失败:', error);
                    // 移除加载状态
                    chartContainer.removeChild(loadingDiv);
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error-message';
                    errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> 加载失败: ${error.message}`;
                    chartContainer.appendChild(errorDiv);
                });
        }

        // 渲染人流量图表
        function renderTrafficChart(trafficData) {
            const canvas = document.getElementById('trafficChart');
            if (!canvas) {
                console.error('Canvas元素未找到！');
                return;
            }
            const ctx = canvas.getContext('2d');

            // 准备图表数据
            const labels = Object.keys(trafficData);
            const data = Object.values(trafficData);

            // 销毁旧图表
            if (window.trafficChartInstance) {
                window.trafficChartInstance.destroy();
            }

            // 创建新图表
            window.trafficChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '人流量',
                        data: data,
                        backgroundColor: 'rgba(74, 111, 203, 0.1)',
                        borderColor: '#4a6fcb',
                        borderWidth: 3,
                        pointBackgroundColor: '#1a2a6c',
                        pointRadius: 4,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: '人流量统计',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `人数: ${context.raw}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '人数'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '时间'
                            }
                        }
                    }
                }
            });
        }

        // 关闭人流量弹窗
        window.closeTrafficModal = function() {
            document.getElementById('trafficModal').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
        };

        // 初始加载
        loadManagerRestaurants();
    });
</script>
</body>
</html>